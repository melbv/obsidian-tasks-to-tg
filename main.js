var m=Object.defineProperty;var A=Object.getOwnPropertyDescriptor;var x=Object.getOwnPropertyNames;var I=Object.prototype.hasOwnProperty;var R=(n,t)=>{for(var e in t)m(n,e,{get:t[e],enumerable:!0})},v=(n,t,e,i)=>{if(t&&typeof t=="object"||typeof t=="function")for(let s of x(t))!I.call(n,s)&&s!==e&&m(n,s,{get:()=>t[s],enumerable:!(i=A(t,s))||i.enumerable});return n};var O=n=>v(m({},"__esModule",{value:!0}),n);var J={};R(J,{default:()=>h});module.exports=O(J);var a=require("obsidian"),w="tasks-tg-key",M="https://api.telegram.org/bot",_={"\u{1F6EB}":"startDate","\u23F3":"scheduledDate","\u{1F4C5}":"dueDate","\u2705":"doneDate","\u2795":"createdDate","\u{1F501}":"recurrence","\u{1F3C1}":"onCompletion","\u{1F194}":"id","\u26D4":"dependsOn","\u{1F53A}":"priority","\u23EB":"priority","\u{1F53C}":"priority","\u{1F53D}":"priority","\u23EC":"priority"},L={"\u{1F53A}":"Highest","\u23EB":"High","\u{1F53C}":"Medium","\u{1F53D}":"Low","\u23EC":"Lowest"},y=Object.keys(_).join(""),N=new RegExp(`[${y}][^${y}]*`,"gu"),D=/#[\w/-]+/g,E=/\[\[([^\]|]+)(?:\|([^\]]+))?\]\]/g,C=/\[([^\]]+)\]\(([^)]+)\)/g,K=/(?<!\]\()https?:\/\/[^\s)]+/g,F={"{task}":"Task content (clean)","{type}":"One-off / Recurring","{priority}":"Priority level","{tags}":"Tags","{links}":"All links (readable)","{doneDate}":"Done date","{dueDate}":"Due date","{scheduledDate}":"Scheduled date","{startDate}":"Start date","{createdDate}":"Creation date","{recurrence}":"Recurrence rule","{onCompletion}":"On Completion action","{id}":"Task ID","{dependsOn}":"Depends-on task ID"},Y=`\u2705 <b>{task}</b>
\u{1F4CB} {type}  |  \u26A1 {priority}
\u{1F4C5} Due: {dueDate}  \xB7  \u2705 Done: {doneDate}
\u{1F3F7} {tags}
\u{1F517} {links}`,G={botToken:"",chatId:"",filters:{oneOff:!0,recurring:!0,tag:"",wikilink:"",link:""},messageTemplate:Y};async function j(){let n=localStorage.getItem(w);if(n){let i=Uint8Array.from(atob(n),s=>s.charCodeAt(0));return crypto.subtle.importKey("raw",i,"AES-GCM",!1,["encrypt","decrypt"])}let t=await crypto.subtle.generateKey({name:"AES-GCM",length:256},!0,["encrypt","decrypt"]),e=await crypto.subtle.exportKey("raw",t);return localStorage.setItem(w,btoa(String.fromCharCode(...new Uint8Array(e)))),t}async function T(n,t){if(!n)return"";let e=crypto.getRandomValues(new Uint8Array(12)),i=await crypto.subtle.encrypt({name:"AES-GCM",iv:e},t,new TextEncoder().encode(n)),s=new Uint8Array(12+i.byteLength);return s.set(e),s.set(new Uint8Array(i),12),btoa(String.fromCharCode(...s))}async function p(n,t){if(!n)return"";try{let e=Uint8Array.from(atob(n),s=>s.charCodeAt(0)),i=await crypto.subtle.decrypt({name:"AES-GCM",iv:e.slice(0,12)},t,e.slice(12));return new TextDecoder().decode(i)}catch(e){return""}}function l(n,t){let e=n.indexOf(t);if(e===-1)return"";let i=n.slice(e+t.length).trimStart(),s=i.search(new RegExp(`[${y}]`,"u"));return(s===-1?i:i.slice(0,s)).trim()}function U(n){return[...n.matchAll(E)].map(t=>{var e;return((e=t[2])!=null?e:t[1]).trim()})}function B(n){let t=[],e=new Set;for(let i of n.matchAll(C))t.push(i[1].trim()),e.add(i[2]);for(let i of n.matchAll(K))e.has(i[0])||t.push(i[0]);return t}function V(n){for(let[t,e]of Object.entries(L))if(n.includes(t))return e;return"Normal"}function X(n){var e;let t=(0,a.moment)().format("YYYY-MM-DD");return{isRecurring:n.includes("\u{1F501}"),priority:V(n),tags:(e=n.match(D))!=null?e:[],wikilinks:U(n),links:B(n),doneDate:l(n,"\u2705")||t,dueDate:l(n,"\u{1F4C5}")||"\u2014",scheduledDate:l(n,"\u23F3")||"\u2014",startDate:l(n,"\u{1F6EB}")||"\u2014",createdDate:l(n,"\u2795")||"\u2014",recurrence:l(n,"\u{1F501}")||"\u2014",onCompletion:l(n,"\u{1F3C1}")||"\u2014",id:l(n,"\u{1F194}")||"\u2014",dependsOn:l(n,"\u26D4")||"\u2014",content:n.replace(N,"").replace(E,(i,s,c)=>(c!=null?c:s).trim()).replace(C,(i,s)=>s.trim()).replace(D,"").replace(/\s{2,}/g," ").trim()}}function b(n,t){return n.replace("{task}",t.content).replace("{type}",t.isRecurring?"Recurring":"One-off").replace("{priority}",t.priority).replace("{tags}",t.tags.join(" ")||"\u2014").replace("{links}",[...t.wikilinks,...t.links].join(", ")||"\u2014").replace("{doneDate}",t.doneDate).replace("{dueDate}",t.dueDate).replace("{scheduledDate}",t.scheduledDate).replace("{startDate}",t.startDate).replace("{createdDate}",t.createdDate).replace("{recurrence}",t.recurrence).replace("{onCompletion}",t.onCompletion).replace("{id}",t.id).replace("{dependsOn}",t.dependsOn)}function $(n,t){return!(!(t.oneOff&&!n.isRecurring)&&!(t.recurring&&n.isRecurring)||t.tag&&!n.tags.some(e=>e===t.tag)||t.wikilink&&!n.wikilinks.some(e=>e.toLowerCase().includes(t.wikilink.toLowerCase()))||t.link&&!n.links.some(e=>e.toLowerCase().includes(t.link.toLowerCase())))}async function S(n,t,e){var s;let i=await fetch(`${M}${n}/sendMessage`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({chat_id:t,text:e,parse_mode:"HTML"})});if(!i.ok){let c=await i.json();throw new Error((s=c==null?void 0:c.description)!=null?s:"Telegram API error")}}var H=/^- \[x\] (.+)/im,h=class extends a.Plugin{constructor(){super(...arguments);this.doneCache=new Map}async onload(){await this.loadSettings(),this.cryptoKey=await j(),this.addSettingTab(new f(this.app,this)),this.registerEvent(this.app.vault.on("modify",e=>{e instanceof a.TFile&&e.extension==="md"&&this.handleFileChange(e)})),this.app.workspace.onLayoutReady(()=>this.buildInitialCache())}async buildInitialCache(){for(let e of this.app.vault.getMarkdownFiles())this.doneCache.set(e.path,this.extractDone(await this.app.vault.read(e)))}extractDone(e){let i=new Set;for(let s of e.split(`
`)){let c=s.match(H);c&&i.add(c[1].trim())}return i}async handleFileChange(e){var d;let i=await this.app.vault.read(e),s=this.extractDone(i),c=(d=this.doneCache.get(e.path))!=null?d:new Set,o=[...s].filter(u=>!c.has(u));if(this.doneCache.set(e.path,s),!o.length)return;let r=await p(this.settings.botToken,this.cryptoKey),g=await p(this.settings.chatId,this.cryptoKey);if(!r||!g){new a.Notice("Tasks\u2192Tg: Bot token or Chat ID not configured.");return}for(let u of o){let k=X(u);if($(k,this.settings.filters))try{await S(r,g,b(this.settings.messageTemplate,k))}catch(P){new a.Notice(`Tasks\u2192Tg: ${P.message}`)}}}async loadSettings(){this.settings=Object.assign({},G,await this.loadData())}async saveSettings(){await this.saveData(this.settings)}},f=class extends a.PluginSettingTab{constructor(e,i){super(e,i);this.tokenPlain="";this.chatIdPlain="";this.plugin=i}async display(){let{containerEl:e}=this,{cryptoKey:i,settings:s}=this.plugin;e.empty(),e.createEl("h2",{text:"Tasks \u2192 Telegram"}),this.tokenPlain=await p(s.botToken,i),this.chatIdPlain=await p(s.chatId,i),e.createEl("h3",{text:"Telegram credentials"}),new a.Setting(e).setName("Bot token").setDesc("From @BotFather \u2014 stored encrypted locally.").addText(o=>o.setPlaceholder("123456:ABC-DEF\u2026").setValue(this.tokenPlain).onChange(async r=>{this.tokenPlain=r,s.botToken=await T(r,i),await this.plugin.saveSettings()})),new a.Setting(e).setName("Chat ID").setDesc("Your personal, group or channel ID.").addText(o=>o.setPlaceholder("-100123456789").setValue(this.chatIdPlain).onChange(async r=>{this.chatIdPlain=r,s.chatId=await T(r,i),await this.plugin.saveSettings()})),e.createEl("h3",{text:"Notification filters"}),e.createEl("p",{text:"All active filters must pass for a notification to fire.",cls:"setting-item-description"}),new a.Setting(e).setName("Notify on one-off tasks").addToggle(o=>o.setValue(s.filters.oneOff).onChange(async r=>{s.filters.oneOff=r,await this.plugin.saveSettings()})),new a.Setting(e).setName("Notify on recurring tasks").addToggle(o=>o.setValue(s.filters.recurring).onChange(async r=>{s.filters.recurring=r,await this.plugin.saveSettings()})),new a.Setting(e).setName("Filter by tag").setDesc("Exact tag match, e.g. #work. Leave empty to disable.").addText(o=>o.setPlaceholder("#work").setValue(s.filters.tag).onChange(async r=>{s.filters.tag=r.trim(),await this.plugin.saveSettings()})),new a.Setting(e).setName("Filter by wikilink").setDesc("Partial match on wikilink target or alias. Leave empty to disable.").addText(o=>o.setPlaceholder("ProjectX").setValue(s.filters.wikilink).onChange(async r=>{s.filters.wikilink=r.trim(),await this.plugin.saveSettings()})),new a.Setting(e).setName("Filter by link").setDesc("Partial match on link alias or URL. Leave empty to disable.").addText(o=>o.setPlaceholder("github.com").setValue(s.filters.link).onChange(async r=>{s.filters.link=r.trim(),await this.plugin.saveSettings()})),e.createEl("h3",{text:"Message template"});let c=e.createEl("table");c.style.cssText="border-collapse:collapse;font-size:.85em;margin-bottom:.75em";for(let[o,r]of Object.entries(F)){let g=c.createEl("tr"),d=g.createEl("td");d.createEl("code",{text:o}),d.style.paddingRight="1em",g.createEl("td",{text:r})}new a.Setting(e).setName("Template").setDesc("HTML tags (<b>, <i>, <code>) are supported by Telegram.").addTextArea(o=>o.setValue(s.messageTemplate).onChange(async r=>{s.messageTemplate=r,await this.plugin.saveSettings()})),e.createEl("h3",{text:"Test"}),new a.Setting(e).setName("Send test message").setDesc("Fires a sample notification using the current template.").addButton(o=>o.setButtonText("Send test").onClick(async()=>{let r=await p(s.botToken,i),g=await p(s.chatId,i);if(!r||!g){new a.Notice("Fill in bot token and chat ID first.");return}let d={content:"Review quarterly report",isRecurring:!1,priority:"High",tags:["#work","#review"],wikilinks:["Q4 Report"],links:["github.com/org/repo"],doneDate:(0,a.moment)().format("YYYY-MM-DD"),dueDate:(0,a.moment)().format("YYYY-MM-DD"),scheduledDate:"\u2014",startDate:"\u2014",createdDate:"\u2014",recurrence:"\u2014",onCompletion:"\u2014",id:"\u2014",dependsOn:"\u2014"};try{await S(r,g,b(s.messageTemplate,d)),new a.Notice("Test message sent!")}catch(u){new a.Notice(`Error: ${u.message}`)}}))}};
