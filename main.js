var w=Object.defineProperty;var O=Object.getOwnPropertyDescriptor;var R=Object.getOwnPropertyNames;var I=Object.prototype.hasOwnProperty;var M=(n,t)=>{for(var e in t)w(n,e,{get:t[e],enumerable:!0})},L=(n,t,e,i)=>{if(t&&typeof t=="object"||typeof t=="function")for(let s of R(t))!I.call(n,s)&&s!==e&&w(n,s,{get:()=>t[s],enumerable:!(i=O(t,s))||i.enumerable});return n};var N=n=>L(w({},"__esModule",{value:!0}),n);var Z={};M(Z,{default:()=>f});module.exports=N(Z);var o=require("obsidian"),E="tasks-tg-key",_="https://api.telegram.org/bot",F={x:"Done",X:"Done (capital)","/":"In Progress","-":"Cancelled",">":"Forwarded","<":"Scheduled","?":"Question","!":"Important","*":"Star",b:"Bookmark",I:"Information",p:"Pro",c:"Con",f:"Fire",k:"Key",w:"Win",u:"Up",d:"Down"},m=["x"],Q={"\u{1F6EB}":"startDate","\u23F3":"scheduledDate","\u{1F4C5}":"dueDate","\u2705":"doneDate","\u2795":"createdDate","\u{1F501}":"recurrence","\u{1F3C1}":"onCompletion","\u{1F194}":"id","\u26D4":"dependsOn","\u{1F53A}":"priority","\u23EB":"priority","\u{1F53C}":"priority","\u{1F53D}":"priority","\u23EC":"priority"},K={"\u{1F53A}":"Highest","\u23EB":"High","\u{1F53C}":"Medium","\u{1F53D}":"Low","\u23EC":"Lowest"},k=Object.keys(Q).join(""),U=new RegExp(`[${k}][^${k}]*`,"gu"),v=/%%([^%]|%(?!%))*%%/g,C=/#[\w/-]+/g,x=/\[\[([^\]|]+)(?:\|([^\]]+))?\]\]/g,A=/\[([^\]]+)\]\(([^)]+)\)/g,$=/(?<!\]\()https?:\/\/[^\s)]+/g,Y={"{task}":"Task content","{comment}":"Task comment (%%\u2026%%)","{type}":"One-off / Recurring","{priority}":"Priority level","{tags}":"Tags","{links}":"All links (readable)","{doneDate}":"Done date","{dueDate}":"Due date","{scheduledDate}":"Scheduled date","{startDate}":"Start date","{createdDate}":"Creation date","{recurrence}":"Recurrence rule","{onCompletion}":"On Completion action","{id}":"Task ID","{dependsOn}":"Depends-on task ID"},B=`\u2705 <b>{task}</b>
\u{1F4AC} {comment}
\u{1F4CB} {type}  |  \u26A1 {priority}
\u{1F4C5} Due: {dueDate}  \xB7  \u2705 Done: {doneDate}
\u{1F3F7} {tags}
\u{1F517} {links}`,h={DROP:"drop",QUEUE:"queue"},j={botToken:"",chatId:"",activeStatuses:m,offlineMode:h.DROP,messageQueue:[],filters:{oneOff:!0,recurring:!0,tag:"",wikilink:"",link:"",comment:""},messageTemplate:B};async function G(){let n=localStorage.getItem(E);if(n){let i=Uint8Array.from(atob(n),s=>s.charCodeAt(0));return crypto.subtle.importKey("raw",i,"AES-GCM",!1,["encrypt","decrypt"])}let t=await crypto.subtle.generateKey({name:"AES-GCM",length:256},!0,["encrypt","decrypt"]),e=await crypto.subtle.exportKey("raw",t);return localStorage.setItem(E,btoa(String.fromCharCode(...new Uint8Array(e)))),t}async function b(n,t){if(!n)return"";let e=crypto.getRandomValues(new Uint8Array(12)),i=await crypto.subtle.encrypt({name:"AES-GCM",iv:e},t,new TextEncoder().encode(n)),s=new Uint8Array(12+i.byteLength);return s.set(e),s.set(new Uint8Array(i),12),btoa(String.fromCharCode(...s))}async function d(n,t){if(!n)return"";try{let e=Uint8Array.from(atob(n),s=>s.charCodeAt(0)),i=await crypto.subtle.decrypt({name:"AES-GCM",iv:e.slice(0,12)},t,e.slice(12));return new TextDecoder().decode(i)}catch(e){return""}}function V(n){let t=n.map(e=>e.replace(/[\]\\^-]/g,"\\$&")).join("");return new RegExp(`^- \\[[${t}]\\] (.+)`,"m")}function u(n,t){let e=n.indexOf(t);if(e===-1)return"";let i=n.slice(e+t.length).trimStart(),s=i.search(new RegExp(`[${k}]`,"u"));return(s===-1?i:i.slice(0,s)).trim()}function q(n){let t=[...n.matchAll(v)];return t.length?t.map(e=>e[0].replace(/^%%|%%$/g,"").trim()).filter(Boolean).join(" / "):"\u2014"}function X(n){return[...n.matchAll(x)].map(t=>{var e;return((e=t[2])!=null?e:t[1]).trim()})}function H(n){let t=[],e=new Set;for(let i of n.matchAll(A))t.push(i[1].trim()),e.add(i[2]);for(let i of n.matchAll($))e.has(i[0])||t.push(i[0]);return t}function W(n){for(let[t,e]of Object.entries(K))if(n.includes(t))return e;return"Normal"}function J(n){var i;let t=(0,o.moment)().format("YYYY-MM-DD");return{comment:q(n),isRecurring:n.includes("\u{1F501}"),priority:W(n),tags:(i=n.match(C))!=null?i:[],wikilinks:X(n),links:H(n),doneDate:u(n,"\u2705")||t,dueDate:u(n,"\u{1F4C5}")||"\u2014",scheduledDate:u(n,"\u23F3")||"\u2014",startDate:u(n,"\u{1F6EB}")||"\u2014",createdDate:u(n,"\u2795")||"\u2014",recurrence:u(n,"\u{1F501}")||"\u2014",onCompletion:u(n,"\u{1F3C1}")||"\u2014",id:u(n,"\u{1F194}")||"\u2014",dependsOn:u(n,"\u26D4")||"\u2014",content:n.replace(v,"").replace(U,"").replace(x,(s,c,a)=>(a!=null?a:c).trim()).replace(A,(s,c)=>c.trim()).replace(C,"").replace(/\s{2,}/g," ").trim()}}function P(n,t){return n.replace("{task}",t.content).replace("{comment}",t.comment).replace("{type}",t.isRecurring?"Recurring":"One-off").replace("{priority}",t.priority).replace("{tags}",t.tags.join(" ")||"\u2014").replace("{links}",[...t.wikilinks,...t.links].join(", ")||"\u2014").replace("{doneDate}",t.doneDate).replace("{dueDate}",t.dueDate).replace("{scheduledDate}",t.scheduledDate).replace("{startDate}",t.startDate).replace("{createdDate}",t.createdDate).replace("{recurrence}",t.recurrence).replace("{onCompletion}",t.onCompletion).replace("{id}",t.id).replace("{dependsOn}",t.dependsOn)}function z(n,t){return!(!(t.oneOff&&!n.isRecurring)&&!(t.recurring&&n.isRecurring)||t.tag&&!n.tags.some(e=>e===t.tag)||t.wikilink&&!n.wikilinks.some(e=>e.toLowerCase().includes(t.wikilink.toLowerCase()))||t.link&&!n.links.some(e=>e.toLowerCase().includes(t.link.toLowerCase()))||t.comment&&n.comment!=="\u2014"&&!n.comment.toLowerCase().includes(t.comment.toLowerCase()))}async function T(n,t,e){var s;let i=await fetch(`${_}${n}/sendMessage`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({chat_id:t,text:e,parse_mode:"HTML"})});if(!i.ok){let c=await i.json();throw new Error((s=c==null?void 0:c.description)!=null?s:"Telegram API error")}}var f=class extends o.Plugin{constructor(){super(...arguments);this.doneCache=new Map}async onload(){await this.loadSettings(),this.cryptoKey=await G(),this.addSettingTab(new D(this.app,this)),this.registerEvent(this.app.vault.on("modify",e=>{e instanceof o.TFile&&e.extension==="md"&&this.handleFileChange(e)})),this.app.workspace.onLayoutReady(async()=>{await this.buildInitialCache(),await this.flushQueue()})}getTriggerRegex(){return V(this.settings.activeStatuses.length?this.settings.activeStatuses:m)}async buildInitialCache(){let e=this.getTriggerRegex();for(let i of this.app.vault.getMarkdownFiles())this.doneCache.set(i.path,this.extractTriggered(await this.app.vault.read(i),e))}extractTriggered(e,i){let s=new Set;for(let c of e.split(`
`)){let a=c.match(i);a&&s.add(a[1].trim())}return s}async enqueue(e){this.settings.messageQueue.push({text:e,queuedAt:new Date().toISOString()}),await this.saveSettings()}async flushQueue(){if(!this.settings.messageQueue.length)return;let e=await d(this.settings.botToken,this.cryptoKey),i=await d(this.settings.chatId,this.cryptoKey);if(!e||!i)return;let s=[],c=0;for(let a of this.settings.messageQueue)try{await T(e,i,a.text),c++}catch(r){s.push(a)}this.settings.messageQueue=s,await this.saveSettings(),c>0&&new o.Notice(`Tasks\u2192Tg: Sent ${c} queued message${c>1?"s":""}.`)}async dispatch(e,i,s){try{await T(i,s,e)}catch(c){this.settings.offlineMode===h.QUEUE?(await this.enqueue(e),new o.Notice("Tasks\u2192Tg: Offline \u2014 message queued for next startup.")):new o.Notice(`Tasks\u2192Tg: ${c.message} (message dropped)`)}}async handleFileChange(e){var p;let i=this.getTriggerRegex(),s=await this.app.vault.read(e),c=this.extractTriggered(s,i),a=(p=this.doneCache.get(e.path))!=null?p:new Set,r=[...c].filter(y=>!a.has(y));if(this.doneCache.set(e.path,c),!r.length)return;let l=await d(this.settings.botToken,this.cryptoKey),g=await d(this.settings.chatId,this.cryptoKey);if(!l||!g){new o.Notice("Tasks\u2192Tg: Bot token or Chat ID not configured.");return}for(let y of r){let S=J(y);z(S,this.settings.filters)&&await this.dispatch(P(this.settings.messageTemplate,S),l,g)}}async loadSettings(){this.settings=Object.assign({},j,await this.loadData()),Array.isArray(this.settings.activeStatuses)||(this.settings.activeStatuses=m),Array.isArray(this.settings.messageQueue)||(this.settings.messageQueue=[])}async saveSettings(){await this.saveData(this.settings)}},D=class extends o.PluginSettingTab{constructor(e,i){super(e,i);this.tokenPlain="";this.chatIdPlain="";this.plugin=i}async display(){let{containerEl:e}=this,{cryptoKey:i,settings:s}=this.plugin;if(e.empty(),e.createEl("h2",{text:"Tasks \u2192 Telegram"}),this.tokenPlain=await d(s.botToken,i),this.chatIdPlain=await d(s.chatId,i),e.createEl("h3",{text:"Telegram credentials"}),new o.Setting(e).setName("Bot token").setDesc("From @BotFather \u2014 stored encrypted locally.").addText(a=>a.setPlaceholder("123456:ABC-DEF\u2026").setValue(this.tokenPlain).onChange(async r=>{this.tokenPlain=r,s.botToken=await b(r,i),await this.plugin.saveSettings()})),new o.Setting(e).setName("Chat ID").setDesc("Your personal, group or channel ID.").addText(a=>a.setPlaceholder("-100123456789").setValue(this.chatIdPlain).onChange(async r=>{this.chatIdPlain=r,s.chatId=await b(r,i),await this.plugin.saveSettings()})),e.createEl("h3",{text:"Offline behaviour"}),new o.Setting(e).setName("When Telegram is unreachable").setDesc(`Drop \u2014 discard the message silently (a notice is still shown).
Queue \u2014 save the message and retry automatically the next time Obsidian opens.`).addDropdown(a=>a.addOption(h.DROP,"Drop message").addOption(h.QUEUE,"Queue and retry on next startup").setValue(s.offlineMode).onChange(async r=>{s.offlineMode=r,await this.plugin.saveSettings(),this.display()})),s.offlineMode===h.QUEUE){let a=s.messageQueue.length,r=new o.Setting(e).setName(`Queued messages: ${a}`).setDesc(a===0?"No messages are waiting to be sent.":`${a} message${a>1?"s":""} will be sent on the next successful connection.`);a>0&&(r.addButton(l=>l.setButtonText("Retry now").onClick(async()=>{await this.plugin.flushQueue(),this.display()})),r.addButton(l=>l.setButtonText("Clear queue").setWarning().onClick(async()=>{s.messageQueue=[],await this.plugin.saveSettings(),new o.Notice("Tasks\u2192Tg: Queue cleared."),this.display()})))}e.createEl("h3",{text:"Trigger statuses"}),e.createEl("p",{text:"Select which task checkbox statuses trigger a Telegram notification.",cls:"setting-item-description"});for(let[a,r]of Object.entries(F))new o.Setting(e).setName(`- [${a}]  ${r}`).addToggle(l=>l.setValue(s.activeStatuses.includes(a)).onChange(async g=>{if(g)s.activeStatuses.includes(a)||s.activeStatuses.push(a);else if(s.activeStatuses=s.activeStatuses.filter(p=>p!==a),!s.activeStatuses.length){s.activeStatuses=m,new o.Notice("Tasks\u2192Tg: At least one trigger status must remain active. Reset to [x]."),this.display();return}await this.plugin.saveSettings()}));e.createEl("h3",{text:"Notification filters"}),e.createEl("p",{text:"All active filters must pass for a notification to fire.",cls:"setting-item-description"}),new o.Setting(e).setName("Notify on one-off tasks").addToggle(a=>a.setValue(s.filters.oneOff).onChange(async r=>{s.filters.oneOff=r,await this.plugin.saveSettings()})),new o.Setting(e).setName("Notify on recurring tasks").addToggle(a=>a.setValue(s.filters.recurring).onChange(async r=>{s.filters.recurring=r,await this.plugin.saveSettings()})),new o.Setting(e).setName("Filter by tag").setDesc("Exact tag match, e.g. #work. Leave empty to disable.").addText(a=>a.setPlaceholder("#work").setValue(s.filters.tag).onChange(async r=>{s.filters.tag=r.trim(),await this.plugin.saveSettings()})),new o.Setting(e).setName("Filter by wikilink").setDesc("Partial match on wikilink target or alias. Leave empty to disable.").addText(a=>a.setPlaceholder("ProjectX").setValue(s.filters.wikilink).onChange(async r=>{s.filters.wikilink=r.trim(),await this.plugin.saveSettings()})),new o.Setting(e).setName("Filter by link").setDesc("Partial match on link alias or URL. Leave empty to disable.").addText(a=>a.setPlaceholder("github.com").setValue(s.filters.link).onChange(async r=>{s.filters.link=r.trim(),await this.plugin.saveSettings()})),new o.Setting(e).setName("Filter by comment").setDesc("Only notify if the task contains a %%comment%% matching this string (partial). Leave empty to disable.").addText(a=>a.setPlaceholder("urgent").setValue(s.filters.comment).onChange(async r=>{s.filters.comment=r.trim(),await this.plugin.saveSettings()})),e.createEl("h3",{text:"Message template"});let c=e.createEl("table");c.style.cssText="border-collapse:collapse;font-size:.85em;margin-bottom:.75em";for(let[a,r]of Object.entries(Y)){let l=c.createEl("tr"),g=l.createEl("td");g.createEl("code",{text:a}),g.style.paddingRight="1em",l.createEl("td",{text:r})}new o.Setting(e).setName("Template").setDesc("HTML tags (<b>, <i>, <code>) are supported by Telegram.").addTextArea(a=>a.setValue(s.messageTemplate).onChange(async r=>{s.messageTemplate=r,await this.plugin.saveSettings()})),e.createEl("h3",{text:"Test"}),new o.Setting(e).setName("Send test message").setDesc("Fires a sample notification using the current template.").addButton(a=>a.setButtonText("Send test").onClick(async()=>{let r=await d(s.botToken,i),l=await d(s.chatId,i);if(!r||!l){new o.Notice("Fill in bot token and chat ID first.");return}let g={content:"Review quarterly report",comment:"Follow up with finance team",isRecurring:!1,priority:"High",tags:["#work","#review"],wikilinks:["Q4 Report"],links:["github.com/org/repo"],doneDate:(0,o.moment)().format("YYYY-MM-DD"),dueDate:(0,o.moment)().format("YYYY-MM-DD"),scheduledDate:"\u2014",startDate:"\u2014",createdDate:"\u2014",recurrence:"\u2014",onCompletion:"\u2014",id:"\u2014",dependsOn:"\u2014"};try{await T(r,l,P(s.messageTemplate,g)),new o.Notice("Test message sent!")}catch(p){new o.Notice(`Error: ${p.message}`)}}))}};
